<!DOCTYPE html>
<html lang="ru" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hoto Messenger</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <style>
        /* === CSS –°–¢–ò–õ–ò === */
        :root {
            --primary-bg: #ffffff;
            --secondary-bg: #f5f5f5;
            --text-primary: #000000;
            --text-secondary: #666666;
            --accent-color: #404040;
            --accent-hover: #2d2d2d;
            --border-color: #d0d0d0;
            --success-color: #4caf50;
            --error-color: #f44336;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            --border-radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --mobile-padding: 16px;
        }

        [data-theme="dark"] {
            --primary-bg: #1a1a1a;
            --secondary-bg: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --accent-color: #808080;
            --accent-hover: #a0a0a0;
            --border-color: #404040;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; background-color: var(--primary-bg); color: var(--text-primary); line-height: 1.6; height: 100vh; overflow: hidden; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
        
        /* Layout */
        .section { display: none; height: 100%; width: 100%; }
        .section.active { display: block; }
        
        .btn-primary { background: var(--accent-color); color: white; border: none; padding: 12px 20px; border-radius: var(--border-radius); cursor: pointer; font-weight: 600; width: 100%; transition: var(--transition); }
        .btn-primary:hover { background: var(--accent-hover); }
        
        .form-input { width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: var(--border-radius); background: var(--primary-bg); color: var(--text-primary); margin-bottom: 12px; }
        
        /* Auth */
        .auth-container { max-width: 400px; margin: 0 auto; padding: 20px; height: 100%; display: flex; flex-direction: column; justify-content: center; }
        .logo { text-align: center; margin-bottom: 30px; }
        .logo h1 { font-size: 2.5rem; }
        
        /* Main App */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid var(--border-color); height: 60px; }
        .main-container { display: flex; height: calc(100vh - 60px); }
        
        /* Sidebar */
        .sidebar { width: 300px; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; background: var(--secondary-bg); }
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border-color); }
        .nav-buttons { display: flex; padding: 10px; gap: 5px; overflow-x: auto; }
        .nav-btn { flex: 1; padding: 8px; border: none; background: none; cursor: pointer; color: var(--text-secondary); border-radius: 8px; white-space: nowrap; }
        .nav-btn.active { background: var(--primary-bg); color: var(--text-primary); font-weight: bold; box-shadow: var(--shadow); }
        
        .user-list { flex: 1; overflow-y: auto; padding: 10px; }
        .user-item { display: flex; align-items: center; gap: 12px; padding: 12px; cursor: pointer; border-radius: 8px; transition: var(--transition); margin-bottom: 4px; }
        .user-item:hover { background: rgba(0,0,0,0.05); }
        [data-theme="dark"] .user-item:hover { background: rgba(255,255,255,0.05); }
        
        .avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--accent-color); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; overflow: hidden; flex-shrink: 0; }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        
        /* Content */
        .content { flex: 1; display: flex; flex-direction: column; background: var(--primary-bg); position: relative; }
        .content-section { display: none; height: 100%; flex-direction: column; }
        .content-section.active { display: flex; }
        
        /* Chat */
        .chat-header { padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; }
        .chat-user-info { display: flex; align-items: center; gap: 10px; }
        .messages-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        
        .message { max-width: 70%; padding: 10px 15px; border-radius: 12px; position: relative; word-wrap: break-word; }
        .message.sent { align-self: flex-end; background: var(--accent-color); color: white; border-bottom-right-radius: 4px; }
        .message.received { align-self: flex-start; background: var(--secondary-bg); color: var(--text-primary); border-bottom-left-radius: 4px; }
        
        .chat-input-area { padding: 15px; border-top: 1px solid var(--border-color); display: flex; gap: 10px; align-items: center; }
        .chat-input { flex: 1; padding: 12px; border: 2px solid var(--border-color); border-radius: 20px; background: var(--primary-bg); color: var(--text-primary); resize: none; height: 48px; line-height: 20px; }
        
        .icon-btn { background: none; border: none; font-size: 20px; cursor: pointer; padding: 8px; border-radius: 50%; color: var(--text-secondary); width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; transition: var(--transition); }
        .icon-btn:hover { background: var(--secondary-bg); color: var(--accent-color); }

        /* === Z-INDEX LAYERS === */
        /* 100 - Header
           1000 - Modals
           10000 - Call UI
           10001 - Call Notifications 
        */

        /* === CALL UI STYLES === */
        .call-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #1a1a1a;
            z-index: 10000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }
        .call-overlay.active { display: flex; }
        
        .video-grid {
            display: flex;
            gap: 20px;
            width: 100%;
            height: 70%;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            padding: 20px;
        }
        
        .video-wrapper {
            position: relative;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        .video-wrapper.remote { width: 640px; height: 480px; max-width: 100%; }
        .video-wrapper.local { width: 240px; height: 180px; position: absolute; bottom: 20px; right: 20px; border: 2px solid #333; }
        
        video { width: 100%; height: 100%; object-fit: cover; }
        
        .call-controls {
            display: flex;
            gap: 20px;
            margin-top: 30px;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 50px;
        }
        
        .call-btn {
            width: 60px; height: 60px;
            border-radius: 50%;
            border: none;
            font-size: 24px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s;
            color: white;
        }
        .call-btn:hover { transform: scale(1.1); }
        .call-btn.mute { background: #555; }
        .call-btn.mute.active { background: #f44336; } /* Red when muted */
        .call-btn.video { background: #555; }
        .call-btn.video.active { background: #f44336; } /* Red when video off */
        .call-btn.end { background: #f44336; transform: rotate(135deg); }
        
        .call-status-text { margin-bottom: 20px; font-size: 1.2rem; opacity: 0.8; }

        /* === INCOMING CALL NOTIFICATION === */
        .call-popup {
            position: fixed;
            top: 20px; right: 20px;
            background: var(--primary-bg);
            border: 2px solid var(--accent-color);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 10001;
            display: none;
            flex-direction: column;
            align-items: center;
            width: 300px;
            animation: slideIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .call-popup.active { display: flex; }
        
        .call-popup-avatar { width: 80px; height: 80px; border-radius: 50%; background: var(--accent-color); margin-bottom: 15px; display: flex; align-items: center; justify-content: center; color: white; font-size: 32px; }
        .call-popup h3 { margin-bottom: 5px; color: var(--text-primary); }
        .call-popup p { margin-bottom: 20px; color: var(--text-secondary); }
        
        .call-popup-actions { display: flex; gap: 15px; width: 100%; justify-content: center; }
        .action-btn { width: 50px; height: 50px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; transition: transform 0.2s; }
        .action-btn:hover { transform: scale(1.1); }
        .action-btn.accept { background: var(--success-color); }
        .action-btn.decline { background: var(--error-color); transform: rotate(135deg); }

        @keyframes slideIn { from { transform: translateY(-100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .main-container { flex-direction: column; }
            .sidebar { width: 100%; height: auto; max-height: 40vh; border-right: none; border-bottom: 1px solid var(--border-color); }
            .video-wrapper.remote { width: 100%; height: 60vh; border-radius: 0; }
            .video-wrapper.local { width: 100px; height: 130px; bottom: 100px; right: 20px; }
            .call-controls { position: absolute; bottom: 30px; }
            .call-popup { left: 20px; right: 20px; width: auto; }
        }
    </style>
</head>
<body>

    <div id="call-screen" class="call-overlay">
        <h3 id="call-status" class="call-status-text">–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...</h3>
        <div class="video-grid">
            <div class="video-wrapper remote">
                <video id="remote-video" autoplay playsinline></video>
            </div>
            <div class="video-wrapper local">
                <video id="local-video" autoplay playsinline muted></video>
            </div>
        </div>
        <div class="call-controls">
            <button class="call-btn mute" id="btn-mute" title="–ú–∏–∫—Ä–æ—Ñ–æ–Ω">üé§</button>
            <button class="call-btn video" id="btn-video" title="–ö–∞–º–µ—Ä–∞">üì∑</button>
            <button class="call-btn end" id="btn-hangup" title="–ó–∞–≤–µ—Ä—à–∏—Ç—å">üìû</button>
        </div>
    </div>

    <div id="incoming-call-popup" class="call-popup">
        <div class="call-popup-avatar" id="popup-avatar">U</div>
        <h3 id="popup-name">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h3>
        <p>–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫...</p>
        <div class="call-popup-actions">
            <button class="action-btn accept" id="btn-accept" title="–ü—Ä–∏–Ω—è—Ç—å">üìû</button>
            <button class="action-btn decline" id="btn-decline" title="–û—Ç–∫–ª–æ–Ω–∏—Ç—å">üìû</button>
        </div>
    </div>

    <div id="auth-section" class="section active">
        <div class="auth-container">
            <div class="logo">
                <h1>Hoto</h1>
                <p>–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</p>
            </div>
            <div id="login-form">
                <input type="email" id="login-email" placeholder="Email" class="form-input">
                <input type="password" id="login-password" placeholder="–ü–∞—Ä–æ–ª—å" class="form-input">
                <button onclick="login()" class="btn-primary">–í–æ–π—Ç–∏</button>
                <p style="text-align: center; margin-top: 15px; cursor: pointer;" onclick="toggleAuth('register')">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</p>
            </div>
            <div id="register-form" style="display: none;">
                <input type="email" id="reg-email" placeholder="Email" class="form-input">
                <input type="text" id="reg-nickname" placeholder="–ù–∏–∫–Ω–µ–π–º" class="form-input">
                <input type="password" id="reg-password" placeholder="–ü–∞—Ä–æ–ª—å" class="form-input">
                <button onclick="register()" class="btn-primary">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
                <p style="text-align: center; margin-top: 15px; cursor: pointer;" onclick="toggleAuth('login')">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç</p>
            </div>
        </div>
    </div>

    <div id="main-section" class="section">
        <header class="header">
            <h2>Hoto</h2>
            <button onclick="logout()" class="icon-btn" title="–í—ã–π—Ç–∏">üö™</button>
        </header>
        <div class="main-container">
            <div class="sidebar">
                <div class="sidebar-header">
                    <h3 id="current-user-name">–ó–∞–≥—Ä—É–∑–∫–∞...</h3>
                </div>
                <div class="nav-buttons">
                    <button class="nav-btn active" onclick="loadChats()">–ß–∞—Ç—ã</button>
                    <button class="nav-btn" onclick="loadAllUsers()">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
                </div>
                <div id="users-list" class="user-list">
                    </div>
            </div>
            <div class="content">
                <div id="chat-view" class="content-section">
                    <div class="chat-header">
                        <div class="chat-user-info">
                            <div class="avatar" id="chat-header-avatar">U</div>
                            <h3 id="chat-header-name">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="icon-btn" onclick="startCall(true)" title="–í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫">üìπ</button>
                            <button class="icon-btn" onclick="startCall(false)" title="–ê—É–¥–∏–æ–∑–≤–æ–Ω–æ–∫">üìû</button>
                        </div>
                    </div>
                    <div id="messages-container" class="messages-container"></div>
                    <div class="chat-input-area">
                        <textarea id="message-input" class="chat-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
                        <button class="icon-btn" style="background: var(--accent-color); color: white;" onclick="sendMessage()">‚û§</button>
                    </div>
                </div>
                <div id="empty-view" class="content-section active" style="align-items: center; justify-content: center; color: var(--text-secondary);">
                    <p>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –Ω–∞—á–∞–ª–∞ –æ–±—â–µ–Ω–∏—è</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === FIREBASE CONFIGURATION ===
        // –í–ê–ñ–ù–û: –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–û–¢ –ö–û–ù–§–ò–ì –ù–ê –í–ê–® –°–û–ë–°–¢–í–ï–ù–ù–´–ô –ò–ó –ö–û–ù–°–û–õ–ò FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyD5uS50WpC2KRXDYY0XNV8II23kbHR_da0", // –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–∞—à —Ä–µ–∞–ª—å–Ω—ã–π –∫–ª—é—á
            authDomain: "hoto-d9e96.firebaseapp.com",
            projectId: "hoto-d9e96",
            storageBucket: "hoto-d9e96.firebasestorage.app",
            messagingSenderId: "1024787203382",
            appId: "1:1024787203382:web:5eb5e82a3337a53ec75f97"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // === GLOBAL VARIABLES ===
        let currentUser = null;
        let currentChatId = null;
        let currentChatUser = null;
        let messagesUnsubscribe = null;

        // === WEBRTC VARIABLES ===
        let localStream = null;
        let remoteStream = null;
        let peerConnection = null;
        let currentCallDocId = null;
        let unsubscribeCallListener = null;
        
        const servers = {
            iceServers: [
                { urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }
            ],
            iceCandidatePoolSize: 10,
        };

        // –û—á–µ—Ä–µ–¥—å –¥–ª—è ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏—à–ª–∏ —Å–ª–∏—à–∫–æ–º —Ä–∞–Ω–æ
        let iceCandidatesQueue = [];

        // === INITIALIZATION ===
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-section').classList.remove('active');
                document.getElementById('main-section').classList.add('active');
                loadUserProfile();
                loadChats();
                initIncomingCallListener(); // START LISTENING FOR CALLS
            } else {
                currentUser = null;
                document.getElementById('auth-section').classList.add('active');
                document.getElementById('main-section').classList.remove('active');
                if (unsubscribeCallListener) unsubscribeCallListener();
            }
        });

        // === AUTH FUNCTIONS ===
        function toggleAuth(type) {
            document.getElementById('login-form').style.display = type === 'login' ? 'block' : 'none';
            document.getElementById('register-form').style.display = type === 'register' ? 'block' : 'none';
        }

        async function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (e) { alert(e.message); }
        }

        async function register() {
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;
            const nickname = document.getElementById('reg-nickname').value;
            try {
                const cred = await auth.createUserWithEmailAndPassword(email, password);
                await db.collection('users').doc(cred.user.uid).set({
                    email, nickname, uid: cred.user.uid,
                    photoURL: '', createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (e) { alert(e.message); }
        }

        async function logout() {
            await auth.signOut();
            window.location.reload();
        }

        async function loadUserProfile() {
            const doc = await db.collection('users').doc(currentUser.uid).get();
            if (doc.exists) {
                document.getElementById('current-user-name').textContent = doc.data().nickname;
            }
        }

        // === CHAT LOGIC ===
        async function loadAllUsers() {
            const list = document.getElementById('users-list');
            list.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            const snapshot = await db.collection('users').get();
            list.innerHTML = '';
            snapshot.forEach(doc => {
                if (doc.id === currentUser.uid) return;
                const user = doc.data();
                const div = document.createElement('div');
                div.className = 'user-item';
                div.innerHTML = `
                    <div class="avatar">${user.nickname[0].toUpperCase()}</div>
                    <div><strong>${user.nickname}</strong></div>
                `;
                div.onclick = () => openChat(user);
                list.appendChild(div);
            });
        }

        async function loadChats() {
            // Simplified for this demo: just calling loadAllUsers
            // In a real app, you'd query a 'chats' collection
            loadAllUsers(); 
        }

        async function openChat(user) {
            currentChatUser = user;
            // Generate chat ID (alphabetical sort to ensure uniqueness between 2 users)
            const ids = [currentUser.uid, user.uid].sort();
            currentChatId = ids.join('_');

            document.getElementById('empty-view').classList.remove('active');
            document.getElementById('chat-view').classList.add('active');
            document.getElementById('chat-header-name').textContent = user.nickname;
            document.getElementById('chat-header-avatar').textContent = user.nickname[0].toUpperCase();

            // Load messages
            if (messagesUnsubscribe) messagesUnsubscribe();
            messagesUnsubscribe = db.collection('chats').doc(currentChatId).collection('messages')
                .orderBy('timestamp')
                .onSnapshot(snapshot => {
                    const container = document.getElementById('messages-container');
                    container.innerHTML = '';
                    snapshot.forEach(doc => {
                        const msg = doc.data();
                        const div = document.createElement('div');
                        div.className = `message ${msg.senderId === currentUser.uid ? 'sent' : 'received'}`;
                        div.textContent = msg.text;
                        container.appendChild(div);
                    });
                    container.scrollTop = container.scrollHeight;
                });
        }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (!text || !currentChatId) return;

            input.value = '';
            await db.collection('chats').doc(currentChatId).collection('messages').add({
                text,
                senderId: currentUser.uid,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        // ==========================================
        // === WEBRTC CALLING SYSTEM IMPLEMENTATION ===
        // ==========================================

        // 1. Setup Audio/Video Elements
        const localVideo = document.getElementById('local-video');
        const remoteVideo = document.getElementById('remote-video');
        const btnMute = document.getElementById('btn-mute');
        const btnVideo = document.getElementById('btn-video');
        const btnHangup = document.getElementById('btn-hangup');

        // 2. Initialize Call Listeners (Incoming calls)
        function initIncomingCallListener() {
            // Listen for calls where 'to' is current user and status is 'calling'
            unsubscribeCallListener = db.collection('calls')
                .where('to', '==', currentUser.uid)
                .where('status', '==', 'calling')
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const callData = change.doc.data();
                            showIncomingCallPopup(change.doc.id, callData);
                        }
                    });
                });
        }

        // 3. UI: Show Incoming Popup
        async function showIncomingCallPopup(callId, data) {
            // Get caller info
            let callerName = "Unknown";
            try {
                const userDoc = await db.collection('users').doc(data.from).get();
                if (userDoc.exists) callerName = userDoc.data().nickname;
            } catch (e) { console.error(e); }

            const popup = document.getElementById('incoming-call-popup');
            document.getElementById('popup-name').textContent = callerName;
            document.getElementById('popup-avatar').textContent = callerName[0].toUpperCase();
            
            popup.classList.add('active');

            // Set button actions
            document.getElementById('btn-accept').onclick = () => acceptCall(callId, data);
            document.getElementById('btn-decline').onclick = () => declineCall(callId);
        }

        // 4. Start Outgoing Call
        async function startCall(isVideo) {
            if (!currentChatUser) {
                alert("–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∑–≤–æ–Ω–∫–∞");
                return;
            }

            // Create Call Document
            const callDocRef = db.collection('calls').doc();
            currentCallDocId = callDocRef.id;

            // Show UI
            document.getElementById('call-screen').classList.add('active');
            document.getElementById('call-status').textContent = "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...";

            // Get Local Stream
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = localStream;
                if (!isVideo) toggleVideo(false); // If audio-only, turn off video track
            } catch (err) {
                alert("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É: " + err.message);
                resetCallState();
                return;
            }

            // Create Peer Connection
            peerConnection = new RTCPeerConnection(servers);
            
            // Add Tracks
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            // Handle ICE Candidates
            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    callDocRef.collection('iceCandidates').add(event.candidate.toJSON());
                }
            };

            // Handle Remote Stream
            peerConnection.ontrack = event => {
                event.streams[0].getTracks().forEach(track => {
                    remoteStream = event.streams[0];
                    remoteVideo.srcObject = remoteStream;
                });
            };

            // Create Offer
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);

            // Write to DB
            const callData = {
                id: currentCallDocId,
                from: currentUser.uid,
                to: currentChatUser.uid,
                offer: { type: offer.type, sdp: offer.sdp },
                status: 'calling',
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            await callDocRef.set(callData);

            document.getElementById('call-status').textContent = "–ó–≤–æ–Ω–æ–∫... –û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞";

            // Listen for Answer
            callDocRef.onSnapshot(async snapshot => {
                const data = snapshot.data();
                if (!peerConnection || !data) return;

                if (data.status === 'accepted' && data.answer && !peerConnection.currentRemoteDescription) {
                    document.getElementById('call-status').textContent = "–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...";
                    const answerDescription = new RTCSessionDescription(data.answer);
                    await peerConnection.setRemoteDescription(answerDescription);
                    processIceQueue(); // Process any queued candidates
                }
                
                if (data.status === 'declined' || data.status === 'ended') {
                    handleHangupLocal();
                }
            });

            // Listen for Remote ICE Candidates
            callDocRef.collection('iceCandidates').onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const candidate = new RTCIceCandidate(change.doc.data());
                        addIceCandidateSafely(candidate);
                    }
                });
            });
        }

        // 5. Accept Incoming Call
        async function acceptCall(callId, callData) {
            currentCallDocId = callId;
            document.getElementById('incoming-call-popup').classList.remove('active');
            document.getElementById('call-screen').classList.add('active');
            document.getElementById('call-status').textContent = "–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...";

            // Get Local Stream
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = localStream;
            } catch (err) {
                alert("–û—à–∏–±–∫–∞ –º–µ–¥–∏–∞: " + err.message);
                declineCall(callId);
                return;
            }

            // Create Peer Connection
            peerConnection = new RTCPeerConnection(servers);
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    db.collection('calls').doc(callId).collection('iceCandidates').add(event.candidate.toJSON());
                }
            };

            peerConnection.ontrack = event => {
                remoteVideo.srcObject = event.streams[0];
                remoteStream = event.streams[0];
            };

            // Set Remote Description (Offer)
            const offerDescription = new RTCSessionDescription(callData.offer);
            await peerConnection.setRemoteDescription(offerDescription);

            // Create Answer
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);

            // Update DB with Answer
            const callDocRef = db.collection('calls').doc(callId);
            await callDocRef.update({
                answer: { type: answer.type, sdp: answer.sdp },
                status: 'accepted'
            });

            // Listen for Remote ICE Candidates
            callDocRef.collection('iceCandidates').onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const data = change.doc.data();
                        // Filter out our own candidates just in case (optional logic usually, but Firebase sends all)
                        // Actually, since we use same collection, we will receive our own. 
                        // PeerConnection handles own candidates gracefully usually, but let's assume valid.
                        const candidate = new RTCIceCandidate(data);
                        addIceCandidateSafely(candidate);
                    }
                });
            });

            // Listen for End Call
            callDocRef.onSnapshot(snapshot => {
                const data = snapshot.data();
                if (data && data.status === 'ended') {
                    handleHangupLocal();
                }
            });
        }

        // 6. Decline Call
        async function declineCall(callId) {
            document.getElementById('incoming-call-popup').classList.remove('active');
            await db.collection('calls').doc(callId).update({ status: 'declined' });
        }

        // 7. Hangup Logic
        btnHangup.onclick = async () => {
            if (currentCallDocId) {
                await db.collection('calls').doc(currentCallDocId).update({ status: 'ended' });
            }
            handleHangupLocal();
        };

        function handleHangupLocal() {
            resetCallState();
        }

        function resetCallState() {
            // Stop tracks
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            if (remoteStream) {
                remoteStream.getTracks().forEach(track => track.stop());
            }

            // Close connection
            if (peerConnection) {
                peerConnection.close();
            }

            // Reset variables
            peerConnection = null;
            localStream = null;
            remoteStream = null;
            currentCallDocId = null;
            iceCandidatesQueue = [];

            // UI
            localVideo.srcObject = null;
            remoteVideo.srcObject = null;
            document.getElementById('call-screen').classList.remove('active');
            document.getElementById('incoming-call-popup').classList.remove('active');
        }

        // 8. Helper: Safe ICE Addition
        function addIceCandidateSafely(candidate) {
            if (peerConnection && peerConnection.remoteDescription) {
                peerConnection.addIceCandidate(candidate).catch(e => console.error("Error adding ice:", e));
            } else {
                iceCandidatesQueue.push(candidate);
            }
        }

        function processIceQueue() {
            iceCandidatesQueue.forEach(candidate => {
                if (peerConnection) {
                    peerConnection.addIceCandidate(candidate).catch(e => console.error("Error processing queue ice:", e));
                }
            });
            iceCandidatesQueue = [];
        }

        // 9. Media Controls
        let isMuted = false;
        let isVideoOff = false;

        btnMute.onclick = () => {
            isMuted = !isMuted;
            localStream.getAudioTracks().forEach(track => track.enabled = !isMuted);
            btnMute.classList.toggle('active', isMuted);
        };

        function toggleVideo(state) {
            // state === false means turn off. undefined means toggle.
            if (state === undefined) isVideoOff = !isVideoOff;
            else isVideoOff = !state;
            
            if (localStream) {
                localStream.getVideoTracks().forEach(track => track.enabled = !isVideoOff);
            }
            btnVideo.classList.toggle('active', isVideoOff);
        }
        
        btnVideo.onclick = () => toggleVideo();

    </script>
</body>
</html>
